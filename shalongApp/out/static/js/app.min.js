angular.module("App",["ionic","App.config","App.services"]).config(["$stateProvider","$urlRouterProvider","$ionicConfigProvider",function(e,t,l){e.state("index",{url:"","abstract":!0,templateUrl:"pages/menu.html",controller:"menuCtrl"}).state("index.home",{url:"/home",views:{home:{templateUrl:"pages/home.html",controller:"homeCtrl"}}}).state("login",{url:"/login",templateUrl:"pages/login.html",controller:"LoginCtrl"}).state("register",{url:"/register",templateUrl:"pages/register.html",controller:"RegCtrl"}).state("myshalong",{url:"/my",templateUrl:"pages/my.html",controller:"MyCtrl"}),t.otherwise("/home")}]).controller("MyYCtrl",["$scope","ENV","callApi","User",function(e,t,l,r){}]);
angular.module("App.config",[]).constant("ENV",{name:"production",debug:!0,version:"1.0.0",api:"http://127.0.0.1:8000/shalong"}).config(["$ionicConfigProvider",function(o){o.tabs.position("bottom")}]);
angular.module("App").controller("homeCtrl",["$scope","$ionicPopup","$log","$rootScope","callApi","User","MessageShow","$ionicScrollDelegate","$state",function(e,t,n,o,s,a,c,i,r){function l(){d(g,function(){},0)}var u=a.getCurrentUser(),g=1,f=5,h=!0;e.questions={};var m=function(n){if(a.judgeUser())c.MessageShow("请先登录",1e3),r.go("login");else{t.show({cssClass:"enroll_popup",title:"提示",scope:e,buttons:[{text:"取消",type:"button-clear",onTap:function(e){console.log("cancle")}},{text:"确定",type:"button-clear",onTap:function(t){e.questions.question?w(n):(alert("请输入问题"),t.preventDefault())}}],template:'<textarea type="text" class="my-input" ng-model="questions.question" placeholder="请输入提问问题"/>'})}},p=[],d=function(t,n,o){var a=u.token||null;s.getData("/item/list","POST",{pagenumber:t,pagesize:f},a).then(function(s){200==s.code?(S(s.content),e.no_content=!1,s.content.length<f&&(e.scrollState=!1,0==s.content.length&&1==t&&(e.no_content=!0)),1==o?(e.jianzhi_info=e.jianzhi_info.concat(s.content),s.content.length<f&&c.MessageShow("没有更多数据",1e3)):0==o?(e.jianzhi_info=s.content,s.content.length<1&&c.MessageShow("暂时没有沙龙",1e3)):(e.jianzhi_info=s.content,c.MessageShow("刷新成功",1e3),s.content.length<1&&c.MessageShow("没有更多数据",1e3))):c.MessageShow(s.content,1e3),n()},function(t){c.MessageShow("网络错误",2e3),e.scrollState=!1,n()})},S=function(e){for(var t=0;t<e.length;t++){e[t].start_time.split("-");e[t].time=e[t].start_time,e[t].state={1:!0,0:!1}[e[t].state]}};e.addItems=function(){g+=1,setTimeout(function(){d(g,function(){e.$broadcast("scroll.infiniteScrollComplete")},1)},1e3)},e.doRefresh=function(){console.log("refresh"),g=1,e.scrollState=!0,d(g,function(){e.$broadcast("scroll.refreshComplete")},2)};var w=function(t){t.state=!1,s.getData("/record/new","POST",{iid:t.iid,questions:e.questions.question},u.token).then(function(e){200==e.code?(c.MessageShow("报名成功",1e3),t.reg_number+=1):(c.MessageShow(e.content,1e3),t.state=!0)},function(e){t.state=!0,c.MessageShow("网络错误",2e3)})};e.jianzhi_info=p,e.enroll=m,e.scrollState=h,l()}]).controller("MyCtrl",["$scope","$ionicPopup","$log","callApi","User","MessageShow","$ionicScrollDelegate","$state",function(e,t,n,o,s,a,c,i){function r(){p(u,function(){},0)}var l=s.getCurrentUser(),u=1,g=!0,f={},h=5;e.comments={};var m=function(n){if(s.judgeUser())a.MessageShow("请先登录",1e3),i.go("login");else if(1==n.state){t.show({cssClass:"enroll_popup",title:"提示",scope:e,buttons:[{text:"取消",type:"button-clear",onTap:function(e){}},{text:"确定",type:"button-clear",onTap:function(e){S(n)}}],template:"<p>确定取消报名该沙龙?</p>"})}else if(2==n.state){t.show({cssClass:"enroll_popup",title:"提示",scope:e,buttons:[{text:"取消",type:"button-clear",onTap:function(e){console.log("cancle")}},{text:"确定",type:"button-clear",onTap:function(t){e.comments.comment?w(n):(alert("请输入评论"),t.preventDefault())}}],template:'<textarea type="text" class="my-input" ng-model="comments.comment" placeholder="请输入评论"/>'})}},p=function(t,n,c){var r=l.token||null;s.judgeUser()?(a.MessageShow("请先登录",1e3),i.go("login")):o.getData("/item/mylist","POST",{pagenumber:t,pagesize:h},r).then(function(o){200==o.code?(d(o.content),e.no_content=!1,o.content.length<h&&(e.scrollState=!1,0==o.content.length&&1==t&&(e.no_content=!0)),1==c?(e.jianzhi_info=e.jianzhi_info.concat(o.content),o.content.length<h&&a.MessageShow("没有更多数据",1e3)):0==c?(e.jianzhi_info=o.content,o.content.length<1&&a.MessageShow("暂时没有兼职",1e3)):(e.jianzhi_info=o.content,o.content.length==h&&(e.scrollState=!0),2===c&&a.MessageShow("刷新成功",1e3))):a.MessageShow(o.content,1e3),n()},function(t){a.MessageShow("网络错误",2e3),e.scrollState=!1,n()})},d=function(e){for(var t=0;t<e.length;t++){var n=e[t].start_time;e[t].time=n,e[t].mystate={3:"完成",1:"取消",2:"评论"}[e[t].state],e[t].enable_state={3:!0,1:!1,2:!1}[e[t].state]}};e.addItems=function(){u+=1,p(u,function(){e.$broadcast("scroll.infiniteScrollComplete")},1e3)},e.doRefresh=function(){u=1,p(u,function(){e.$broadcast("scroll.refreshComplete")},2)};var S=function(e){e.state=!1,o.getData("/record/delete","POST",{rid:e.rid},l.token).then(function(e){200==e.code?(a.MessageShow("退出报名成功",1e3),p(u,function(){},2)):a.MessageShow(e.content,1e3)},function(e){a.MessageShow("网络错误",2e3)})},w=function(t){t.state=!1,o.getData("/comment/new","POST",{iid:t.iid,comment:e.comments.comment},l.token).then(function(e){200==e.code?(a.MessageShow("评论成功",1e3),p(u,function(){},2)):a.MessageShow(e.content,1e3)},function(e){a.MessageShow("网络错误",2e3)})};e.jianzhi_info=f,e.enroll=m,e.scrollState=g,r()}]).controller("menuCtrl",["$scope","User","MessageShow","$log","$rootScope","$state","callApi",function(e,t,n,o,s,a,c){function i(){l()}t.getCurrentUser();console.log("state",t.judgeUser());var r={username:"点击登录",state:!t.judgeUser()},l=function(){t.judgeUser()?e.info={username:"点击登录",state:!1}:c.getData("/info/get","POST",null,t.getCurrentUser().token).then(function(t){200==t.code?(e.info.username=t.content.name,e.info.state=!0):o.debug(t.content)},function(e){n.MessageShow("网络错误",1e3)})};e.logout=function(){t.logout(),l()};var u=function(){t.judgeUser()?a.go("login"):a.go("index.home")};e.get_picture_click=u,s.$on("update",function(){l()}),i(),e.info=r}]).controller("LoginCtrl",["User","$scope","$log","MessageShow","$state","$stateParams","EventService",function(e,t,n,o,s,a,c){t.formData={login_username:"",login_password:""};var i="index.home",r=function(e){return e.login_username.length<1?"用户名不能为空!":e.login_password.length<1?"密码不能为空":null},l=function(){var a=r(t.formData);a?t.error_message=a:e.login(t.formData.login_username,t.formData.login_password).then(function(e){n.debug(e),e?t.error_message=e:(o.MessageShow("登录成功",1e3),c.broadcast("update"),s.transitionTo(i,{},{reload:!0,notify:!0}))},function(e){o.MessageShow("网络错误",1e3)})};t.login=l}]).controller("RegCtrl",["$scope","User","$log","MessageShow","$state","EventService",function(e,t,n,o,s,a){var c="index.home";e.formData={reg_username:"",pwd:"",reg_cardnum:""};var i=function(e){return e.reg_username.length<1?"用户名不能为空!":e.pwd.length<1?"密码不能为空":e.reg_cardnum.length<1?"一卡通号不能为空":null};e.register=function(r){var l=i(e.formData);l?e.error_message=l:t.register(e.formData.reg_username,e.formData.pwd,e.formData.reg_cardnum).then(function(t){n.debug(t),t?e.error_message=t:(o.MessageShow("注册成功",1e3),a.broadcast("update"),setTimeout(function(){s.transitionTo(c,{},{reload:!0,notify:!0})},1e3))},function(e){o.MessageShow("网络错误",1e3)})}}]);
angular.module("App.services",[]).service("Storage",["ENV",function(e){this.set=function(e,t){return window.localStorage.setItem(e,window.JSON.stringify(t))},this.get=function(e){return window.JSON.parse(window.localStorage.getItem(e))},this.remove=function(e){return window.localStorage.removeItem(e)}}]).service("User",["Storage","callApi","$q","$log",function(e,t,n,r){var o="shalonguser",i=e.get(o)||{};this.login=function(r,s){return data={user_phone:r,password:s},loginDefer=n.defer(),t.getData("/auth/login","POST",data).then(function(t){200==t.code?(i.token=t.content,e.set(o,i),loginDefer.resolve(null)):loginDefer.resolve(t.content)},function(e){loginDefer.reject(e)}),loginDefer.promise},this.register=function(r,s,a){return data={phone:r,password:s,cardnum:a},registerDefer=n.defer(),t.getData("/auth/reg","POST",data).then(function(t){200==t.code?(i.token=t.content,e.set(o,i),registerDefer.resolve(null)):registerDefer.resolve(t.content)},function(e){registerDefer.reject(e)}),registerDefer.promise},this.logout=function(){e.remove(o),i={}},this.judgeUser=function(){for(name in i)return!1;return!0},this.getCurrentUser=function(){return i},this.refresh_user=function(){return i=e.get(o)||{}}}]).service("MessageShow",["$ionicLoading",function(e){this.errorShow=function(t){e.show({template:t,noBackdrop:!0,duration:2e3})},this.MessageShow=function(t,n){var n=2e3|n;e.show({template:t,noBackdrop:!0,duration:n})},this.show=function(t){e.show({template:t,noBackdrop:!0})},this.hide=function(){e.hide()}}]).service("EventService",["$rootScope",function(e){var t={broadcast:function(t){setTimeout(function(){e.$broadcast(t)},100)}};return t}]).service("callApi",["$http","ENV","$q","$log",function(e,t,n,r){var o=1;this.namedata=function(){return o},this.getData=function(r,o,i,s,a){var u=n.defer(),c=t.api+r;i=i||null,a=a||null;var f={method:o,url:c,headers:{token:s},timeout:5e3};return"GET"==o?f.params=i:"POST"==o&&(a||(f.transformRequest=function(e){var t=[];for(var n in e)"data"!=n?t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n])):t.push(encodeURIComponent(n)+"="+JSON.stringify(e[n]));return t.join("&")}),f.headers["Content-Type"]="application/x-www-form-urlencoded",f.data=i),e(f).success(function(e){u.resolve(e)}).error(function(e,t,n){u.reject(e)}),u.promise}}]);